---
interface Props {
  gp: any;
  roundLabel: string;
}

const { gp, roundLabel } = Astro.props;

// Validación de seguridad: si no hay datos, no renderizar nada para evitar errores
if (!gp) return;

// Lógica para calcular el rango de fechas (Inicio - Fin)
const startDate = new Date(gp.fecha);
let endDate = new Date(gp.fecha);

if (gp.sesiones && gp.sesiones.length > 0) {
    const raceSession = gp.sesiones.find((s: any) => s.tipo === 'Race');
    if (raceSession) {
        endDate = new Date(raceSession.inicio);
    } else {
        endDate = new Date(gp.sesiones[gp.sesiones.length - 1].inicio);
    }
}

const startDay = startDate.getDate();
const endDay = endDate.getDate();
const startMonth = startDate.toLocaleString('default', { month: 'short' });
const endMonth = endDate.toLocaleString('default', { month: 'short' });

let dayDisplay = `${startDay}`;
let monthDisplay = startMonth;

if (endDate.getTime() > startDate.getTime()) {
     if (startMonth === endMonth) {
         if (startDay !== endDay) dayDisplay = `${startDay}-${endDay}`; 
     } else {
         dayDisplay = `${startDay}-${endDay}`;
         monthDisplay = `${startMonth}/${endMonth}`;
     }
}
---

<a href={`/circuitos/${gp.id}`} class="card-item group relative bg-surface rounded-2xl overflow-hidden border border-white/10 hover:border-accent transition-all duration-300 hover:shadow-[0_0_30px_rgba(6,182,212,0.15)] hover:-translate-y-2 flex flex-col" data-name={gp.nombre} data-country={gp.pais}>
  
  {/* Barra superior decorativa roja que aparece al hacer hover */}
  <div class="h-1 w-full bg-gradient-to-r from-accent to-secondary transform origin-left scale-x-0 group-hover:scale-x-100 transition-transform duration-500"></div>

  <div class="p-6 flex flex-col h-full relative z-10">
    
    {/* Cabecera: Ronda y Fecha */}
    <div class="flex justify-between items-start mb-6">
      <div class="flex flex-col">
        <span class="text-accent text-xs font-black uppercase tracking-widest mb-1">
          {roundLabel}
        </span> 
        <div class="flex items-center gap-2">
          <img transition:name={`flag-${gp.id}`} src={gp.bandera} alt={`Bandera ${gp.pais}`} class="w-6 h-auto rounded-sm shadow-sm opacity-80 group-hover:opacity-100 transition-opacity" />
          <span class="text-text font-bold text-sm uppercase tracking-wider">{gp.pais}</span>
        </div>
      </div>
      
      {/* Badge de Fecha estilo calendario */}
      <div class="flex flex-col items-center bg-surface-hover rounded-lg px-3 py-2 border border-white/10 group-hover:bg-white/10 transition-colors">
        <span class="text-xl md:text-2xl font-black text-text leading-none whitespace-nowrap">{dayDisplay}</span>
        <span class="text-[10px] font-bold text-accent uppercase tracking-wide">{monthDisplay}</span>
      </div>
    </div>

    {/* Título del GP */}
    <div class="mb-6">
      <h2 transition:name={`title-${gp.id}`} class="text-xl font-bold text-text italic leading-tight group-hover:text-secondary transition-colors duration-300">
        {gp.nombre}
      </h2>
      <p class="text-xs text-text-muted mt-2 line-clamp-1 font-medium">
        {gp.info_tecnica ? gp.info_tecnica.split('.')[0] : ''}
      </p>
    </div>

    {/* Mapa del Circuito */}
    <div class="relative h-40 w-full flex items-center justify-center mb-6 mt-auto group-hover:scale-105 transition-transform duration-500">
      {/* Efecto de brillo rojo detrás del mapa al hacer hover */}
      <div class="absolute inset-0 bg-accent opacity-0 group-hover:opacity-5 blur-2xl rounded-[10px] transition-opacity duration-500"></div>
      
      {/* Imagen invertida para que se vea blanca sobre fondo oscuro */}
      <img 
        transition:name={`map-${gp.id}`}
        src={gp.imagen_circuito} 
        alt={`Circuito de ${gp.nombre}`} 
        class="h-full w-full object-contain filter invert opacity-60 group-hover:opacity-100 transition-all duration-500 drop-shadow-[0_0_8px_rgba(255,255,255,0.1)]" 
      />
    </div>

    {/* Footer: Neumáticos y Año */}
    <div class="border-t border-white/10 pt-4 flex justify-between items-center">
       {
        gp.neumaticos_sugeridos && gp.neumaticos_sugeridos.length > 0 ? (
            <div class="flex gap-1 items-center">
              <span class="text-[10px] text-text-muted mr-1 uppercase font-bold">Tyres</span>
              {gp.neumaticos_sugeridos.slice(0, 3).map((n: string, i: number) => (
                <span class={`w-5 h-5 rounded-[10px] flex items-center justify-center text-[9px] font-bold border border-white/10 ${
                  i === 0 ? 'bg-white text-black' :
                  i === 1 ? 'bg-[#ffd700] text-black' :
                  'bg-[#e10600] text-white'
                }`}>
                  {n}
                </span> 
              ))}
            </div>
        ) : null }
       
       <span class="text-[10px] text-text-muted font-mono group-hover:text-text transition-colors">
          {new Date(gp.fecha).getFullYear()}
       </span>
    </div>

  </div>
</a>