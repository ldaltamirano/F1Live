---
import Layout from '../../layouts/Layout.astro';
import fs from 'node:fs/promises';
import path from 'node:path';
import MarkdownIt from 'markdown-it';
import Badge from '@components/ui/Badge.astro';
import Button from '@components/ui/Button.astro';
import { getNewsBySlug } from '@lib/services/newssService';

export const prerender = false;

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/404');
}

const newsItem = await getNewsBySlug(id);

if (!newsItem) {
  return Astro.redirect('/404');
}

const formattedDate = newsItem.fecha ? new Date(newsItem.fecha).toLocaleDateString('es-ES', {
  day: 'numeric',
  month: 'long',
  year: 'numeric'
}) : '';

// Leer el contenido del archivo Markdown
let content = '';
try {
  let filePath;
  // Verificar si es una noticia nueva (ruta en DB) o legacy (nombre de archivo)
  if (newsItem.contenido && newsItem.contenido.startsWith('/uploads')) {
      // Eliminar el slash inicial para que path.join lo trate como ruta relativa dentro de public
      const relativePath = newsItem.contenido.startsWith('/') ? newsItem.contenido.slice(1) : newsItem.contenido;
      filePath = path.join(process.cwd(), 'public', relativePath);
  }

  if (filePath) {
    const rawContent = await fs.readFile(filePath, 'utf-8');
    const ext = path.extname(filePath).toLowerCase();

    if (ext === '.html') {
      content = rawContent;
    } else {
      const md = new MarkdownIt({ html: true });
      content = md.render(rawContent);
    }
  }
} catch (error) {
  console.error(`Error al leer el archivo de noticia ${id}:`, error);
  content = "<p>Contenido no disponible.</p>";
}

const tags = (newsItem.tags && Array.isArray(newsItem.tags)) ? newsItem.tags : [];
---

<Layout 
  title={`${newsItem.titulo} - F1 Live`}
  description={newsItem.bajada}
  image={newsItem.imagen}
>
  <article class="bg-bg min-h-screen text-text pt-24 pb-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
      
      {/* Botón Volver */}
      <Button href="/" variant="ghost">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Home
      </Button>

      {/* Header de la noticia */}
      <header class="mb-8">
        <div class="flex flex-wrap gap-2 mb-4">
          {tags.map((tag: string) => (
            <Badge variant="gradient">{tag}</Badge>
          ))}
        </div>
        
        <h1 class="text-3xl md:text-5xl font-black italic uppercase leading-tight mb-4">
          {newsItem.titulo}
        </h1>

        <p class="text-xl text-text-muted font-medium leading-relaxed mb-8 border-l-4 border-secondary pl-4">
          {newsItem.bajada}
        </p>

        <div class="flex items-center gap-4 text-sm text-secondary border-b border-white/10 pb-6">
          <span>{formattedDate}</span>
          {newsItem.autor && (
            <>
              <span class="w-1 h-1 bg-gray-600 rounded-[10px]"></span>
              <span class="text-white font-medium">By {newsItem.autor}</span>
            </>
          )}
          {newsItem.fuente && (
             <>
              <span class="w-1 h-1 bg-gray-600 rounded-[10px]"></span>
              <span class="text-accent font-bold">{newsItem.fuente}</span>
            </>
          )}
        </div>
      </header>

      {/* Imagen Principal */}
      {newsItem.imagen && (
        <div class="relative aspect-video w-full overflow-hidden rounded-2xl mb-10 border border-white/10 shadow-2xl">
          <img 
            src={newsItem.imagen} 
            alt={newsItem.titulo} 
            class="w-full h-full object-cover"
          />
        </div>
      )}

      {/* Cuerpo de la noticia */}
      <div id="contenido" class="prose prose-invert prose-lg max-w-none">
        <div set:html={content} />
      </div>

      {/* Galería (si existe) */}
      {newsItem.galeria && Array.isArray(newsItem.galeria) && newsItem.galeria.length > 0 && (
        <div class="mt-12">
          <h3 class="text-2xl font-bold mb-6">Galería</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {newsItem.galeria.map((img) => (
              <div class="rounded-lg overflow-hidden border border-white/10">
                <img src={img} class="w-full h-full object-cover hover:scale-105 transition-transform duration-500" loading="lazy" />
              </div>
            ))}
          </div>
        </div>
      )}

    </div>
  </article>
</Layout>