---
import Button from "@components/ui/Button.astro";
import Layout from "@layouts/Layout.astro";
import CircuitMap from "@components/CircuitMap.astro";

---

<Layout title="F1 Live - Panel">
  <!-- VISTA INTRO (Landing / Semáforo) - Copiada de index.astro -->
  <div id="intro-view" class="relative min-h-[calc(100vh-5rem)] bg-brand-black text-brand-white flex flex-col overflow-hidden font-sans">
    <div class="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-brand-dark-red blur-[150px] opacity-30 pointer-events-none rounded-[10px]"></div>

    <main class="flex-1 flex flex-col items-center justify-center z-10 relative">
      <div class="text-center mb-16 animate-in fade-in zoom-in duration-700">
        <h1 class="text-5xl md:text-7xl font-black uppercase italic tracking-wide leading-tight">
          Gran Premio <br />
          <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-white via-brand-silver to-brand-white">
            de Australia
          </span>
        </h1>
      </div>

      <Button id="start-btn" text="Iniciar Fin de Semana" />

      <div class="mt-16 flex flex-col items-center gap-4">
        <div class="bg-brand-black p-4 rounded-2xl flex gap-3 border border-gray-800 shadow-2xl relative">
          <div class="f1-light w-10 h-10 md:w-12 md:h-12 rounded-[10px] bg-gray-900 border border-gray-700 transition-all duration-150"></div>
          <div class="f1-light w-10 h-10 md:w-12 md:h-12 rounded-[10px] bg-gray-900 border border-gray-700 transition-all duration-150"></div>
          <div class="f1-light w-10 h-10 md:w-12 md:h-12 rounded-[10px] bg-gray-900 border border-gray-700 transition-all duration-150"></div>
          <div class="f1-light w-10 h-10 md:w-12 md:h-12 rounded-[10px] bg-gray-900 border border-gray-700 transition-all duration-150"></div>
          <div class="f1-light w-10 h-10 md:w-12 md:h-12 rounded-[10px] bg-gray-900 border border-gray-700 transition-all duration-150"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- VISTA LIVE (Panel de Control) -->
  <div id="live-view" class="hidden min-h-screen w-full bg-brand-black text-brand-white font-sans p-8">
    <!-- Header simple -->
    <header class="flex justify-end items-center mb-8">
        <div class="flex items-center gap-2 bg-gray-900 px-4 py-2 rounded-[10px] border border-gray-800">
          <span class="block w-3 h-3 rounded-[10px] bg-brand-red animate-pulse shadow-[0_0_10px_var(--color-brand-red)]"></span>
          <span class="text-brand-red font-bold tracking-widest text-sm">EN VIVO</span>
        </div>
    </header>

    <main class="max-w-4xl mx-auto text-center mt-20">
      <h1 class="text-5xl font-black italic uppercase mb-6">
        Panel de Control
      </h1>
      <p class="text-xl text-brand-silver mb-12">
        Aquí se mostrarán los datos de telemetría y tiempos en tiempo real.
      </p>

      <CircuitMap />

      <!-- Botón para resetear la demo -->
      <div id="reset-container">
        <Button text="Finalizar Sesión" class="bg-gray-800 hover:bg-gray-700" />
      </div>
    </main>
  </div>
</Layout>

<script>
  // Elementos del DOM
  const introView = document.getElementById('intro-view');
  const liveView = document.getElementById('live-view');
  const startBtn = document.getElementById('start-btn');
  const lights = document.querySelectorAll('.f1-light');
  const resetBtn = document.querySelector("#reset-container button");

  // Función para cambiar a vista LIVE
  function showLive() {
    introView?.classList.add('hidden');
    liveView?.classList.remove('hidden');
  }

  // Función para cambiar a vista INTRO
  function showIntro() {
    introView?.classList.remove('hidden');
    liveView?.classList.add('hidden');
    // Resetear luces
    lights.forEach(l => {
      l.classList.remove('bg-brand-red', 'shadow-[0_0_30px_var(--color-brand-red)]');
      l.classList.add('bg-gray-900');
    });
    startBtn?.removeAttribute('disabled');
  }

  // 1. Verificar estado al cargar
  if (localStorage.getItem("weekendStarted") === "true") {
    showLive();
  } else {
    showIntro();
  }

  // 2. Lógica del botón de inicio (Intro)
  startBtn?.addEventListener("click", async () => {
    if (startBtn.hasAttribute("disabled")) return;
    startBtn.setAttribute("disabled", "true");

    // Secuencia de luces
    for (let i = 0; i < 5; i++) {
      if (i > 0) await new Promise((r) => setTimeout(r, 1000));
      lights[i].classList.remove("bg-gray-900");
      lights[i].classList.add("bg-brand-red", "shadow-[0_0_30px_var(--color-brand-red)]");
    }

    // Esperar con luces encendidas y luego "largar"
    await new Promise((r) => setTimeout(r, 2000));
    
    localStorage.setItem("weekendStarted", "true");
    showLive();
  });

  // 3. Lógica del botón de reset (Live)
  resetBtn?.addEventListener("click", () => {
    localStorage.removeItem("weekendStarted");
    showIntro();
  });
</script>