---
import "@styles/global.css";
import Layout from "@layouts/Layout.astro";
import fs from 'node:fs/promises';
import path from 'node:path';
import CircuitCard from "@components/circuitos/CircuitCard.astro";

// Carga de datos
const filePath = path.join(process.cwd(), 'public', 'calendario_f1_2026.json');
let circuitos: any[] = [];

try {
  const fileContent = await fs.readFile(filePath, 'utf-8');
  const data = JSON.parse(fileContent);
  if (Array.isArray(data)) {
    circuitos = data;
  }
} catch (error) {
  console.error("Error al cargar el calendario:", error);
}

let rondaCounter = 0;
---

<Layout title="Circuitos F1 2026">
  <!-- Fondo oscuro principal (#15151e) para consistencia con el resto del sitio -->
  <div class="bg-bg min-h-screen py-12 px-4 sm:px-6 lg:px-8">
    
    <div class="max-w-7xl mx-auto">
      <!-- Título con tipografía estilo racing -->
      <h1 class="text-4xl md:text-6xl font-black text-center text-text mb-16 uppercase italic tracking-tighter">
        F1 Schedule <span class="text-accent">2026</span>
      </h1>

      {/* Buscador de Circuitos */}
      <div class="max-w-xl mx-auto mb-12 relative group z-20">
        <div class="absolute -inset-1 bg-gradient-to-r from-accent to-secondary rounded-lg blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
        <input 
          type="text" 
          id="searchInput"
          placeholder="Buscar circuito o país..." 
          class="relative w-full bg-surface text-text border border-white/10 rounded-lg py-4 px-6 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent placeholder-text-muted transition-all"
        />
        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-text-muted pointer-events-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>

      <div id="circuitGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {circuitos.filter(gp => gp).map((gp) => {
        const esTest = gp.nombre.includes('Testing');
        if (!esTest) rondaCounter++;
        
        return (
            <CircuitCard 
              gp={gp} 
              roundLabel={esTest ? 'Pre-Season' : `Round ${rondaCounter}`} 
            />

          );
        })}
      </div>
      
      {/* Mensaje sin resultados */}
      <div id="noResults" class="hidden text-center text-text-muted mt-12">
        <p class="text-xl italic">No se encontraron circuitos que coincidan con tu búsqueda.</p>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    const searchInput = document.getElementById('searchInput');
    const cards = document.querySelectorAll('.card-item');
    const noResults = document.getElementById('noResults');

    searchInput?.addEventListener('input', (e) => {
      const term = (e.target as HTMLInputElement).value.toLowerCase();
      let visibleCount = 0;

      cards.forEach((card) => {
        const el = card as HTMLElement;
        const name = el.dataset.name?.toLowerCase() || '';
        const country = el.dataset.country?.toLowerCase() || '';
        
        if (name.includes(term) || country.includes(term)) {
          el.style.display = ''; // Restaura el display original (flex)
          visibleCount++;
        } else {
          el.style.display = 'none';
        }
      });

      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }
    });
  });
</script>
