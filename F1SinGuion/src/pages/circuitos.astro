---
import Layout from "../layouts/Layout.astro";
import fs from 'node:fs/promises';
import path from 'node:path';
import CircuitCard from "./circuitos/CircuitCard.astro";

// Carga de datos
const filePath = path.join(process.cwd(), 'public', 'calendario_f1_2026.json');
let circuitos = [];

try {
  const fileContent = await fs.readFile(filePath, 'utf-8');
  circuitos = JSON.parse(fileContent);
} catch (error) {
  console.error("Error al cargar el calendario:", error);
}

let rondaCounter = 0;
---

<Layout title="Circuitos F1 2026">
  <!-- Fondo oscuro principal (#15151e) para consistencia con el resto del sitio -->
  <div class="bg-[#15151e] min-h-screen py-12 px-4 sm:px-6 lg:px-8">
    
    <div class="max-w-7xl mx-auto">
      <!-- Título con tipografía estilo racing -->
      <h1 class="text-4xl md:text-6xl font-black text-center text-white mb-16 uppercase italic tracking-tighter">
        F1 Schedule <span class="text-[#e10600]">2026</span>
      </h1>

      {/* Buscador de Circuitos */}
      <div class="max-w-xl mx-auto mb-12 relative group z-20">
        <div class="absolute -inset-1 bg-gradient-to-r from-[#e10600] to-red-900 rounded-lg blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
        <input 
          type="text" 
          id="searchInput"
          placeholder="Buscar circuito o país..." 
          class="relative w-full bg-[#1e1e24] text-white border border-white/10 rounded-lg py-4 px-6 focus:outline-none focus:border-[#e10600] focus:ring-1 focus:ring-[#e10600] placeholder-gray-500 transition-all"
        />
        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>

      <div id="circuitGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {circuitos.map((gp) => {
        const esTest = gp.nombre.includes('Testing');
        if (!esTest) rondaCounter++;
        
        // Lógica para calcular el rango de fechas (Inicio - Fin)
        const startDate = new Date(gp.fecha);
        let endDate = new Date(gp.fecha);
        
        if (gp.sesiones && gp.sesiones.length > 0) {
            const raceSession = gp.sesiones.find(s => s.tipo === 'Race');
            if (raceSession) {
                endDate = new Date(raceSession.inicio);
            } else {
                endDate = new Date(gp.sesiones[gp.sesiones.length - 1].inicio);
            }
        }

        const startDay = startDate.getDate();
        const endDay = endDate.getDate();
        const startMonth = startDate.toLocaleString('default', { month: 'short' });
        const endMonth = endDate.toLocaleString('default', { month: 'short' });
        
        let dayDisplay = `${startDay}`;
        let monthDisplay = startMonth;

        // Si la fecha de fin es posterior a la de inicio, mostramos el rango
        if (endDate.getTime() > startDate.getTime()) {
             if (startMonth === endMonth) {
                 // Mismo mes: "06-08"
                 if (startDay !== endDay) dayDisplay = `${startDay}-${endDay}`;
             } else {
                 // Cruce de mes: "30-01" y mes "Oct/Nov"
                 dayDisplay = `${startDay}-${endDay}`;
                 monthDisplay = `${startMonth}/${endMonth}`;
             }
        }

          return (
          <a href={`/circuitos/${gp.id}`} class="card-item group relative bg-[#1e1e24] rounded-2xl overflow-hidden border border-white/5 hover:border-[#e10600] transition-all duration-300 hover:shadow-[0_0_30px_rgba(225,6,0,0.15)] hover:-translate-y-2 flex flex-col" data-name={gp.nombre} data-country={gp.pais}>
            
            {/* Barra superior decorativa roja que aparece al hacer hover */}
            <div class="h-1 w-full bg-gradient-to-r from-[#e10600] to-red-900 transform origin-left scale-x-0 group-hover:scale-x-100 transition-transform duration-500"></div>

            <div class="p-6 flex flex-col h-full relative z-10">
              
              {/* Cabecera: Ronda y Fecha */}
              <div class="flex justify-between items-start mb-6">
                <div class="flex flex-col">
                  <span class="text-[#e10600] text-xs font-black uppercase tracking-widest mb-1">
                    {esTest ? 'Pre-Season' : `Round ${rondaCounter}`}
                  </span> 
                  <div class="flex items-center gap-2">
                    <img transition:name={`flag-${gp.id}`} src={gp.bandera} alt={`Bandera ${gp.pais}`} class="w-6 h-auto rounded-sm shadow-sm opacity-80 group-hover:opacity-100 transition-opacity" />
                    <span class="text-white/90 font-bold text-sm uppercase tracking-wider">{gp.pais}</span>
                  </div>
                </div>
                
                {/* Badge de Fecha estilo calendario */}
                <div class="flex flex-col items-center bg-white/5 rounded-lg px-3 py-2 border border-white/5 group-hover:bg-white/10 transition-colors">
                  <span class="text-xl md:text-2xl font-black text-white leading-none whitespace-nowrap">{dayDisplay}</span>
                  <span class="text-[10px] font-bold text-[#e10600] uppercase tracking-wide">{monthDisplay}</span>
                </div>
              </div>

              {/* Título del GP */}
              <div class="mb-6">
                <h2 transition:name={`title-${gp.id}`} class="text-xl font-bold text-white italic leading-tight group-hover:text-[#e10600] transition-colors duration-300">
                  {gp.nombre}
                </h2>
                <p class="text-xs text-gray-500 mt-2 line-clamp-1 font-medium">
                  {gp.info_tecnica ? gp.info_tecnica.split('.')[0] : ''}
                </p>
              </div>

              {/* Mapa del Circuito */}
              <div class="relative h-40 w-full flex items-center justify-center mb-6 mt-auto group-hover:scale-105 transition-transform duration-500">
                {/* Efecto de brillo rojo detrás del mapa al hacer hover */}
                <div class="absolute inset-0 bg-[#e10600] opacity-0 group-hover:opacity-5 blur-2xl rounded-full transition-opacity duration-500"></div>
                
                {/* Imagen invertida para que se vea blanca sobre fondo oscuro */}
                <img 
                  transition:name={`map-${gp.id}`}
                  src={gp.imagen_circuito} 
                  alt={`Circuito de ${gp.nombre}`} 
                  class="h-full w-full object-contain filter invert opacity-60 group-hover:opacity-100 transition-all duration-500 drop-shadow-[0_0_8px_rgba(255,255,255,0.1)]" 
                />
              </div>

              {/* Footer: Neumáticos y Año */}
              <div class="border-t border-white/5 pt-4 flex justify-between items-center">
                 {
                  gp.neumaticos_sugeridos && gp.neumaticos_sugeridos.length > 3 ? (
                      <div class="flex gap-1 items-center">
                        <span class="text-[10px] text-gray-600 mr-1 uppercase font-bold">Tyres</span>
                        {gp.neumaticos_sugeridos.slice(0, 5).map(n => (
                          <span class={`w-5 h-5 rounded-full flex items-center justify-center text-[9px] font-bold border border-white/10 ${
                            n === 'C1' || n === 'C2' ? 'bg-white text-black' :
                            n === 'C3' ? 'bg-[#ffd700] text-black' :
                            'bg-[#e10600] text-white'
                          }`}>
                            {n}
                          </span>
                        ))}
                      </div>
                  ) : 
                      <div class="flex gap-1 items-center">
                        <span class="text-[10px] text-gray-600 mr-1 uppercase font-bold">Tyres</span>
                        {gp.neumaticos_sugeridos.slice(0, 3).map((n, i) => (
                          <span class={`w-5 h-5 rounded-full flex items-center justify-center text-[9px] font-bold border border-white/10 ${
                            i === 0 ? 'bg-white text-black' :
                            i === 1 ? 'bg-[#ffd700] text-black' :
                            'bg-[#e10600] text-white'
                          }`}>
                            {n}
                          </span>
                        ))}
                      </div>
                 }
                 
                 <span class="text-[10px] text-gray-600 font-mono group-hover:text-white transition-colors">
                    {new Date(gp.fecha).getFullYear()}
                 </span>
              </div>

            </div>
          </a>
          );
        })}
      </div>
      
      {/* Mensaje sin resultados */}
      <div id="noResults" class="hidden text-center text-gray-500 mt-12">
        <p class="text-xl italic">No se encontraron circuitos que coincidan con tu búsqueda.</p>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    const searchInput = document.getElementById('searchInput');
    const cards = document.querySelectorAll('.card-item');
    const noResults = document.getElementById('noResults');

    searchInput?.addEventListener('input', (e) => {
      const term = (e.target as HTMLInputElement).value.toLowerCase();
      let visibleCount = 0;

      cards.forEach((card) => {
        const el = card as HTMLElement;
        const name = el.dataset.name?.toLowerCase() || '';
        const country = el.dataset.country?.toLowerCase() || '';
        
        if (name.includes(term) || country.includes(term)) {
          el.style.display = ''; // Restaura el display original (flex)
          visibleCount++;
        } else {
          el.style.display = 'none';
        }
      });

      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }
    });
  });
</script>
