---
import '@styles/global.css';
import Layout from '@layouts/Layout.astro';
// Usamos alias para importar los componentes de forma segura
import CircuitHero from '@components/circuitos/CircuitHero.astro';
import CircuitMap from '@components/circuitos/CircuitMap.astro';
import SessionTimes from '@components/circuitos/SessionTimes.astro';
import TyreCompounds from '@components/circuitos/TyreCompounds.astro';
import Button from '@components/ui/Button.astro';
import {  getcircuitsBySlug } from "@lib/services/circuitsService";

// Habilitamos SSR (Server Side Rendering) para esta página
export const prerender = false;

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/404');
}

// Buscamos el circuito por slug (index)
let gp = await getcircuitsBySlug(id);

if (!gp) {
  return Astro.redirect('/404');
}

// Determinamos el label de la ronda usando el campo 'round' de la DB
let roundDisplay = "Pre-Season";
if (gp.round && gp.round > 0) {
    roundDisplay = `Round ${gp.round}`;
}

const hasInfo = !!gp.infoTecnica;
const hasHistory = !!gp.resenaHistorica;
const hasTyres = gp.neumaticosSugeridos && gp.neumaticosSugeridos.length > 0;
---

<Layout title={`${gp.nombre} - F1 2026`}>
  <div class="bg-bg min-h-screen text-text">
    
    {/* Hero Section con Imagen de Fondo */}
    <CircuitHero gp={gp} roundDisplay={roundDisplay}>
      <Button slot="back-button" href="/circuitos" variant="ghost" >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Schedule
      </Button>
    </CircuitHero>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 -mt-20 relative z-20">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        
        {/* Columna Principal: Mapa e Info */}
        <div class="lg:col-span-2 space-y-12">
          
          {/* Mapa con efecto de brillo */}
          <CircuitMap gp={gp} />

          {/* Estadísticas del Circuito */}
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-surface p-4 rounded-xl border border-white/5 flex flex-col items-center justify-center text-center hover:border-white/10 transition-colors">
                <span class="text-text-muted text-[10px] uppercase font-bold tracking-wider mb-1">First GP</span>
                <span class="text-xl font-black text-accent">{gp.primerGranPremio || '-'}</span>
            </div>
            <div class="bg-surface p-4 rounded-xl border border-white/5 flex flex-col items-center justify-center text-center hover:border-white/10 transition-colors">
                <span class="text-text-muted text-[10px] uppercase font-bold tracking-wider mb-1">Laps</span>
                <span class="text-xl font-black text-text">{gp.vueltas || '-'}</span>
            </div>
            <div class="bg-surface p-4 rounded-xl border border-white/5 flex flex-col items-center justify-center text-center hover:border-white/10 transition-colors">
                <span class="text-text-muted text-[10px] uppercase font-bold tracking-wider mb-1">Length</span>
                <span class="text-xl font-black text-text">{gp.longitud || '-'} <span class="text-xs font-normal text-text-muted">km</span></span>
            </div>
          </div>

          {/* Detalles Técnicos e Históricos */}
          {(hasInfo || hasHistory) && (
            <div class={`grid grid-cols-1 ${hasInfo && hasHistory ? 'md:grid-cols-2' : ''} gap-6`}>
              {hasInfo && (
                <div class="bg-surface p-8 rounded-2xl border-l-4 border-secondary">
                  <h3 class="text-lg font-bold uppercase mb-4 text-text flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Technical Info
                  </h3>
                  <p class="text-text-muted leading-relaxed text-sm">{gp.infoTecnica}</p>
                  {gp.recordVuelta && (
                    <div class="mt-4 pt-4 border-t border-white/5 flex items-center justify-between">
                        <span class="text-xs font-bold text-text-muted uppercase">Lap Record</span>
                        <span class="text-sm font-mono font-bold text-accent">{gp.recordVuelta}</span>
                    </div>
                  )}
                </div>
              )}
              {hasHistory && (
                <div class="bg-surface p-8 rounded-2xl border-l-4 border-secondary">
                  <h3 class="text-lg font-bold uppercase mb-4 text-text flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    History
                  </h3>
                  <p class="text-text-muted leading-relaxed text-sm">{gp.resenaHistorica}</p>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Sidebar: Horarios y Neumáticos */}
        <div class="space-y-8">
          
          {/* Horarios */}
          <SessionTimes sesiones={gp.sessions} status={gp.estado} />

          {/* Neumáticos (Diseño realista: goma negra con borde de color) */}
          {hasTyres && (
            <TyreCompounds compounds={gp.neumaticosSugeridos} />
          )}

        </div>
      </div>
    </div>
  </div>
</Layout>
