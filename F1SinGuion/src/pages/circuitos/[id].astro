---
import '@styles/global.css';
import Layout from '@layouts/Layout.astro';
import fs from 'node:fs/promises';
import path from 'node:path';
// Usamos alias para importar los componentes de forma segura
import CircuitHero from '@components/circuitos/CircuitHero.astro';
import CircuitMap from '@components/circuitos/CircuitMap.astro';
import SessionTimes from '@components/circuitos/SessionTimes.astro';
import TyreCompounds from '@components/circuitos/TyreCompounds.astro';
import Button from '@components/ui/Button.astro';

interface Session {
  id: number;
  nombre: string;
  tipo: string;
  inicio: string;
}

interface Circuit {
  id: number;
  nombre: string;
  pais: string;
  bandera: string;
  background: string;
  imagen_circuito: string;
  info_tecnica: string;
  resena_historica: string;
  neumaticos_sugeridos: string[];
  fecha: string;
  sesiones: Session[];
}

export async function getStaticPaths() {
  const filePath = path.join(process.cwd(), 'public', 'calendario_f1_2026.json');
  let circuitos: Circuit[] = [];
  try {
    const fileContent = await fs.readFile(filePath, 'utf-8');
    const data = JSON.parse(fileContent);
    // Validamos que sea un array antes de asignarlo
    if (Array.isArray(data)) {
      circuitos = data;
    }
  } catch (error) {
    console.error("Error al cargar el calendario:", error);
    return [];
  }

  let roundCounter = 0;
  
  return circuitos.filter(gp => gp.id).map((gp) => {
    let roundDisplay = "Pre-Season";
    if (!gp.nombre.includes('Testing')) {
        roundCounter++;
        roundDisplay = `Round ${roundCounter}`;
    }

    return {
        params: { id: gp.id.toString() },
        props: { gp, roundDisplay },
    };
  });
}

interface Props {
  gp: Circuit;
  roundDisplay: string;
}

const { gp, roundDisplay } = Astro.props;
---

<Layout title={`${gp.nombre} - F1 2026`}>
  <div class="bg-bg min-h-screen text-text">
    
    {/* Hero Section con Imagen de Fondo */}
    <CircuitHero gp={gp} roundDisplay={roundDisplay}>
      <Button slot="back-button" href="/circuitos" variant="ghost" >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Schedule
      </Button>
    </CircuitHero>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 -mt-20 relative z-20">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        
        {/* Columna Principal: Mapa e Info */}
        <div class="lg:col-span-2 space-y-12">
          
          {/* Mapa con efecto de brillo */}
          <CircuitMap gp={gp} />

          {/* Detalles Técnicos e Históricos */}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-surface p-8 rounded-2xl border-l-4 border-secondary">
              <h3 class="text-lg font-bold uppercase mb-4 text-text flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Technical Info
              </h3>
              <p class="text-text-muted leading-relaxed text-sm">{gp.info_tecnica}</p>
            </div>
            <div class="bg-surface p-8 rounded-2xl border-l-4 border-secondary">
              <h3 class="text-lg font-bold uppercase mb-4 text-text flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                History
              </h3>
              <p class="text-text-muted leading-relaxed text-sm">{gp.resena_historica}</p>
            </div>
          </div>
        </div>

        {/* Sidebar: Horarios y Neumáticos */}
        <div class="space-y-8">
          
          {/* Horarios */}
          <SessionTimes sesiones={gp.sesiones} />

          {/* Neumáticos (Diseño realista: goma negra con borde de color) */}
          {gp.neumaticos_sugeridos && (
            <TyreCompounds compounds={gp.neumaticos_sugeridos} />
          )}

        </div>
      </div>
    </div>
  </div>
</Layout>
