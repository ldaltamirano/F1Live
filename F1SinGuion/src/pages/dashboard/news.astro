---
import DashboardLayout from '@layouts/DashboardLayout.astro';
import { getAllNews, deleteNews, getNewsById } from '@lib/services/newssService';
import fs from 'node:fs/promises';
import path from 'node:path';

export const prerender = false;

let data = [];
let errorMsg = null;
let successMsg = null;

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const id = formData.get("id")?.toString();
    if (id) {
      // Obtener la noticia para saber su slug (index) y borrar la carpeta correcta
      const newsItem = await getNewsById(id);
      
      if (newsItem && newsItem.index) {
          const newsDir = path.join(process.cwd(), 'public', 'uploads', 'news', newsItem.index);
          await fs.rm(newsDir, { recursive: true, force: true }).catch(() => {});
      }

      await deleteNews(id);
      successMsg = "Noticia eliminada correctamente.";
    }
  } catch (e) {
    console.error(e);
    errorMsg = "Error al borrar la noticia.";
  }
}

try {
  data = await getAllNews();
} catch (e) {
  console.error(e);
  errorMsg = "Error cargando noticias.";
}

const formatDate = (dateStr) => {
  if (!dateStr) return '-';
  return new Date(dateStr).toLocaleDateString('es-ES', {
    day: '2-digit', month: 'short', year: 'numeric'
  });
};
---

<DashboardLayout title="Noticias">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-text">Noticias</h1>
      <p class="text-text-muted text-sm">Gestión de artículos y novedades</p>
    </div>
    <div class="flex gap-4 items-center">
      <div class="text-sm text-text-muted">
        Total: <span class="font-bold text-white">{data.length}</span>
      </div>
      <a href="/dashboard/news/create" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded text-sm font-medium transition-colors">
        + Nueva Noticia
      </a>
    </div>
  </div>

  {successMsg && (
    <div class="mb-4 p-4 bg-green-500/10 border border-green-500/20 rounded text-green-400">{successMsg}</div>
  )}

  {errorMsg ? (
    <div class="p-4 bg-red-500/10 border border-red-500/20 rounded text-red-400">{errorMsg}</div>
  ) : (
    <div class="bg-surface border border-white/5 rounded-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-text-muted">
          <thead class="bg-white/5 text-text uppercase font-medium text-xs">
            <tr>
              <th class="px-6 py-3">Fecha</th>
              <th class="px-6 py-3">Título</th>
              <th class="px-6 py-3">Autor</th>
              <th class="px-6 py-3">Estado</th>
              <th class="px-6 py-3">Categoría</th>
              <th class="px-6 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5">
            {data.map((item) => (
              <tr class="hover:bg-white/5 transition-colors group">
                <td class="px-6 py-4 font-mono text-xs">{formatDate(item.fecha)}</td>
                <td class="px-6 py-4 font-medium text-text max-w-xs truncate" title={item.titulo}>
                  <a href={`/noticias/${item.index}`} target="_blank" class="hover:text-primary transition-colors">
                    {item.titulo}
                  </a>
                </td>
                <td class="px-6 py-4">{item.autor}</td>
                <td class="px-6 py-4">
                  <span class={`px-2 py-1 rounded text-xs font-medium ${
                    item.estado === 'publicada' ? 'bg-green-500/10 text-green-400' : 
                    item.estado === 'borrador' ? 'bg-yellow-500/10 text-yellow-400' : 
                    'bg-white/5 text-text-muted'
                  }`}>
                    {item.estado}
                  </span>
                </td>
                <td class="px-6 py-4">{item.categoria}</td>
                <td class="px-6 py-4 text-right">
                  <a href={`/dashboard/news/${item.id}`} class="text-primary hover:text-white transition-colors mr-3">Editar</a>
                  <form method="POST" class="inline" onsubmit="return confirm('¿Estás seguro de eliminar esta noticia? Esta acción no se puede deshacer.');">
                    <input type="hidden" name="id" value={item.id} />
                    <button type="submit" class="text-red-400 hover:text-red-300 transition-colors">Borrar</button>
                  </form>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )}
</DashboardLayout>