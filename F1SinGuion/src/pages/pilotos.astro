---
import Layout from "../layouts/Layout.astro";
import DriverCard from "@components/pilotos/DriverCard.astro";
import TeamLogo from "@components/escuderias/TeamLogo.astro";
import { getAllDrivers } from "@lib/services/driversService";

let driversByTeam: { team: any, drivers: any[] }[] = [];

try {
  // Carga de datos desde la base de datos
  const driversData = await getAllDrivers();

  // Agrupar pilotos por equipo usando un Map para evitar duplicados
  const teamsMap = new Map();

  driversData.forEach((driver: any) => {
    if (driver.team) {
      const teamKey = driver.team.index;
      if (!teamsMap.has(teamKey)) {
        teamsMap.set(teamKey, { team: driver.team, drivers: [] });
      }
      teamsMap.get(teamKey).drivers.push(driver);
    }
  });

  driversByTeam = Array.from(teamsMap.values());

} catch (error) {
  console.error("Error al cargar los pilotos:", error);
}
---

<Layout title="F1 Live - Pilotos">
  <div class="bg-bg min-h-screen py-12 px-4 sm:px-6 lg:px-8 relative overflow-hidden">
    
    {/* Texture Overlay (Carbon Fiber feel) */}
    <div class="absolute inset-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 4px 4px;"></div>
    
    {/* Ambient Background */}
    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-[600px] blur-[150px] rounded-full pointer-events-none"></div>
    <div class="absolute bottom-0 right-0 w-[600px] h-[600px] bg-cyan-900/10 blur-[150px] rounded-full pointer-events-none"></div>

    <div class="max-w-7xl mx-auto relative z-10">
      <h1 class="text-4xl md:text-6xl font-black text-center text-white mb-16 uppercase italic tracking-tighter">
        F1 Drivers <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-600">2026</span>
      </h1>

      <div class="space-y-20">
        {driversByTeam.map(({ team, drivers }) => (
          <section class="relative">
             {/* Team Header */}
             <div class="flex items-end gap-6 mb-8 border-b border-white/5 pb-4">
                <div class="w-32 h-32 bg-white/90 rounded-xl p-3 backdrop-blur-sm border border-white/10 flex items-center justify-center shrink-0">
                    <TeamLogo slug={team.nombre} class="max-w-full max-h-full object-contain" />
                </div>
                <div>
                    <h2 class="text-3xl md:text-4xl font-black text-white italic uppercase tracking-tighter leading-none mb-1">
                        {team.nombre}
                    </h2>
                    <div class="h-1 w-full max-w-[200px] rounded-full" style={`background-color: ${team.colorVar}`}></div>
                </div>
             </div>

             {/* Drivers Grid */}
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {drivers.map((driver) => (
                  <DriverCard driver={driver} />
                ))}
             </div>
          </section>
        ))}
      </div>
    </div>
  </div>
</Layout>